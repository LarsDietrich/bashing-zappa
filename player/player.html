<!DOCTYPE html>
<html>
  <head>
  	<meta charset="utf-8" />
    <title>Bashing: <%= title %></title>

	<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
	<script>
	window.GameHost = { name: '<%= name %>' }
	</script>
    <style>
    	* {
    		margin:0;
    		padding:0;
    	}
    	html, body {
    		width:100%;
    		height:100%;
    	}
    	body {
    		background:url(/img/bg_control.png);
    		background-size:100% 100%;
    		background-position:0 0;
    	}
    	#container {
    		
    	}
    	#gamepad-container {
    		float:left;
    		height:100%;
    		width:60%;
    		display:block;
    	}
    	#gamepad {
    		width:180px;
    		height:180px;	
    		background:url(/img/joystick_socket.png);
    		background-size:100% 100%;
    		margin-top:20px;
    		margin-left:20px;
    	}
    	#gamepad-button {
    		left:2px;
    		top:2px;	
    		background:black;
    		position:absolute;
    		width:80px;
    		height:80px;
    		background:url(/img/joystick.png);
    		background-size:100% 100%;
    	}
    	#button-container {
    		float:left;
    		height:100%;
    		width:40%;
    		display:block;
    		display:none;
    	}
    	#console {
    		background:black;
    		color:white;
    		font-family:"monospace";
    		bottom:0;
    		width:400px;
    		height:20px;
    		position:absolute;
    	}
    </style>
  </head>
  <body>

	<div id="gamepad-container">
		<div id="gamepad"><div id="gamepad-button"></div></div> 

    </div>
	<div id="button-container">
	</div>
	<div id="console"></div>



	<script src="/socket.io/socket.io.js"></script>
	<script src="/zappa/zappa.js"></script>
	<script src="/js/jquery.min.js"></script>
	<script src="/js/plugins/touchable.js"></script>
	<script src="/play/js/socket.js" />
	<script src="/js/gamepad/gamepad.js"></script>
	<script>
		var div = $("#gamepad").Touchable();
		$("#gamepad-container").bind("mousemove", onGamepadMoved);
		$("#gamepad-container").bind("touchmove", onGamepadMoved);

		function onGamepadMoved(e)
		{
			if (typeof e.pageX == 'undefined')
				return;

			var gamepad = $("#gamepad");
			var centerX = gamepad.offset().left + Math.round(gamepad.width() / 2);
			var centerY = gamepad.offset().top + Math.round(gamepad.height() / 2);

			var x = e.pageX - centerX;
			var y = e.pageY - centerY;
			var d = distance(0, 0, x, y );
			var maxDistance = 60;
            var dPower = maxDistance / d;
			if (d > maxDistance) {
				
				x = Math.round(x * dPower);
				y = Math.round(y * dPower);
			}

			$("#gamepad").trigger("touchmoved", [{ x: x, y: y }]);
			
			var console = $("#console");
			console.text('x:' + x + ', y:' + y + ', dist:' + d  + ', dpower:' + dPower);

			//button positioning
			var button = $("#gamepad-button");
			var buttonX = x + centerX - Math.round($(button).width() / 2);
			var buttonY = y + centerY - Math.round($(button).height() / 2);
			button.css({left: buttonX + 'px', top: buttonY + 'px'});
		}

		function distance(x1, y1, x2, y2) {
			return Math.sqrt((x2-x1)*(x2-x1)+(y2-y1)*(y2-y1));
		}
		
		/*$('#gamepad').live('touchstart', function(e) {
		  var xPos = e.originalEvent.touches[0].pageX;
		  alert(xPos);
		}
		alert('');*/
	</script>
  </body> 
</html>
