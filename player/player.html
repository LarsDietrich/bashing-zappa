<!DOCTYPE html>
<html>
  <head>
  	<meta charset="utf-8" />
    <title>Bashing: <%= title %></title>

	<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
	<script>
	window.GameHost = { name: '<%= name %>' }
	</script>
    <style>
    	* {
    		margin:0;
    		padding:0;
    	}
    	html, body {
    		width:100%;
    		height:100%;
    	}
    	body {
    		background:url(/img/bg_control.png);
    		background-size:100% 100%;
    		background-position:0 0;
    	}
    	#container {
    		
    	}
    	#gamepad-container {
    		float:left;
    		height:100%;
    		width:60%;
    		display:block;
    	}
    	#gamepad {
    		width:180px;
    		height:180px;	
    		background:url(/img/joystick_socket.png);
    		background-size:100% 100%;
    		margin-top:20px;
    		margin-left:20px;
    		position: relative;
    	}
    	#gamepad-button {
    		left:50px;
    		top:50px;	
    		background:black;
    		position:absolute;
    		width:80px;
    		height:80px;
    		background:url(/img/joystick.png);
    		background-size:100% 100%;
    	}
    	#button-container {
    		float:left;
    		height:100%;
    		width:40%;
    		display:block;
    		display:none;
    	}
    	#console {
    		background:black;
    		color:white;
    		font-family:"monospace";
    		bottom:0;
    		width:400px;
    		height:20px;
    		position:absolute;
    	}
    </style>
  </head>
  <body>

	<div id="gamepad-container">
		<div id="gamepad"><div id="gamepad-button"></div></div> 

    </div>
	<div id="button-container">
	</div>
	<div id="console"></div>



	<script src="/socket.io/socket.io.js"></script>
	<script src="/zappa/zappa.js"></script>
	<script src="/js/jquery.min.js"></script>

	<script src="/play/js/socket.js"></script>
	<script src="/js/gamepad/gamepad.js"></script>
	<script>
/*
 * Gamepad 
 */		
function Gamepad() {
    
    //constants
    this.maxDistance = 60;
    this.velocity = 150;
    
    this.x = 0;
    this.y = 0;
    this.touchStartX = 0;
    this.touchEndX = 0;
		
    //this.touchable = $("#gamepad-container").Touchable();
    this.gamepad = $("#gamepad");
		this.centerX = this.gamepad.offset().left + Math.round(this.gamepad.width() / 2);
		this.centerY = this.gamepad.offset().top + Math.round(this.gamepad.height() / 2);

    this.button = $("#gamepad-button");
		this.buttonCenterX = this.centerX - Math.round($(this.button).width() / 2);
		this.buttonCenterY = this.centerY - Math.round($(this.button).height() / 2);
		    
    
		//bindings
	//	var _instance = this; // Yikes
		//$("#gamepad-container").bind("mousemove", function(e) {_instance.onMove(e)}, false);
		//$("#gamepad-container").bind("touchstart", function(e) {_instance.onTouchStart(e)}, false);
		//$("#gamepad-container").bind("touchmove", function(e) {_instance.onMove(e)}, false);
		
		//init 
		//this.renderButton(this.x, this.y);
};

/*
Gamepad.prototype.onTouchStart = function(e){
    this.touchStartX = e.touches[0].pageX;
    this.touchEndX = e.touches[0].pageY;
    alert(this.touchStartX);
};*/

Gamepad.prototype.onMove = function(e){
    alert(e);
    e.preventDefault();
    var pageX, pageY;
	  if(e.touches) {
		  pageX = this.touchStartX + e.touches[0].pageX;
		  pageY = this.touchStartY + e.touches[0].pageY;
	  } 
	  else {
		  pageX = e.pageX
		  pageY = e.pageY
	  }
	  var x = pageX - this.centerX;
	  var y = pageY - this.centerY;
	  
		var distance = this.getDistance(0, 0, x, y);
		
		// maximum movement
		if (distance > this.maxDistance) {
			var dPow = this.maxDistance / distance;
			x = Math.round(x * dPow);
			y = Math.round(y * dPow);
		}
		
		Utils.console.write('x:' + this.toServer(x) + ', y:' + this.toServer(y) + ', dist:' + distance  + ', dpower:' + dPow);
		
		// nodejs trigger
		$("#gamepad").trigger("touchmoved", [{ x: this.toServer(x), y: this.toServer(y) }]);
		
		this.renderButton(x, y);
};

Gamepad.prototype.toServer = function(num){
    return Math.round(num * (this.velocity / this.maxDistance));
}

Gamepad.prototype.getDistance = function(x1, y1, x2, y2) {
    return Math.sqrt((x2-x1)*(x2-x1)+(y2-y1)*(y2-y1));
};

Gamepad.prototype.getMoreDistance = function(x1, y1, x2, y2) {
    return Math.sqrt((x2-x1)*(x2-x1)+(y2-y1)*(y2-y1));
};

Gamepad.prototype.renderButton = function(x, y) {
		var buttonX = x + this.buttonCenterX;
		var buttonY = y + this.buttonCenterY;
		this.button.css({left: buttonX + 'px', top: buttonY + 'px'});
};


/*
 * Console
 */		
function Console() {
  this.output = $("#console"); 
};

Console.prototype.write = function(text){
  this.output.text(text);
}; 

var Utils = {};
Utils.console = new Console();
var gamepad = new Gamepad();





	</script>
  </body> 
</html>
